"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.printers = exports.languages = exports.parsers = void 0;
const prettier_1 = require("prettier");
const parser_html_1 = require("prettier/parser-html");
const blockHashes = new Array();
const htmlParser = parser_html_1.parsers.html;
let _id = 0;
const getId = () => {
    _id = _id + (1 % Number.MAX_SAFE_INTEGER);
    return _id.toString();
};
const buildReplacement = (input, allTagsClosed) => {
    const id = getId();
    if (allTagsClosed && input.match(/{{[-<]? (?:if|range|block|with|define)/)) {
        blockHashes.push(id);
        return `<BPGT${id}EPGT>`;
    }
    if (allTagsClosed && input.match(/{{[-<]? end/)) {
        return `</BPGT${blockHashes.pop()}EPGT>`;
    }
    return `BPGT${id}EPGT`;
};
const replacements = new Map();
exports.parsers = {
    "go-template": Object.assign(Object.assign({}, htmlParser), { astFormat: "go-template", preprocess: (text) => {
            var _a, _b;
            const regexp = /(?:{{.*?}})|(?:<script(?:\n|.)*?>)((?:\n|.)*?)(?:<\/script>)/gm;
            let replacedText = text.trim();
            let match;
            while ((match = regexp.exec(text)) != null) {
                const result = match[0];
                if (!result.includes("{{")) {
                    continue;
                }
                const cleanedResult = result
                    .replace(/{{(?![-<]|(?:\/\*))[ \t]*/g, "{{ ")
                    .replace(/[ \t]*(?<![->]|(?:\*\/))}}/g, " }}")
                    .replace(/{{-[ \t]*/g, "{{- ")
                    .replace(/[ \t]*-}}/g, " -}}")
                    .replace(/{{<[ \t]*/g, "{{< ")
                    .replace(/[ \t]*>}}/g, " >}}")
                    .replace(/ *\n/g, "\n")
                    .trim();
                const resultIndex = replacedText.indexOf(result);
                const prefixString = replacedText.substring(0, resultIndex);
                const openingTags = (_a = prefixString.match(/<[\w/]/)) === null || _a === void 0 ? void 0 : _a.length;
                const closingTags = (_b = prefixString.match(/[\w/]>/)) === null || _b === void 0 ? void 0 : _b.length;
                const replacement = buildReplacement(cleanedResult, openingTags === closingTags);
                replacedText = replacedText.replace(result, replacement);
                const forceLinebreak = !!replacedText.match(new RegExp(`^[ \t]*${replacement}[ \t]*$`, "gm"));
                if (forceLinebreak && !replacement.includes("<")) {
                    const linebreakReplacement = `<!--BPGT${replacement}EPGT-->`;
                    replacedText = replacedText.replace(replacement, linebreakReplacement);
                    replacements.set(linebreakReplacement, cleanedResult);
                }
                else {
                    replacements.set(replacement, cleanedResult);
                }
            }
            if (blockHashes.length > 0) {
                throw Error("Missing ending block.");
            }
            return replacedText;
        } }),
};
exports.languages = [
    {
        name: "GoTemplate",
        parsers: ["go-template"],
        extensions: [
            ".go.html",
            ".gohtml",
            ".gotmpl",
            ".go.tmpl",
            ".tmpl",
            ".tpl",
            ".html.tmpl",
            ".html.tpl",
        ],
        vscodeLanguageIds: ["gotemplate", "gohtml", "GoTemplate", "GoHTML"],
    },
];
function replaceSingles(input, replacedHashes = new Array()) {
    const regexp = /(?:<!--BPGT)?BPGT.*?EPGT(?:EPGT-->)?/g;
    let result = input;
    let match;
    while ((match = regexp.exec(input)) != null) {
        const hash = match[0];
        const replacement = replacements.get(hash);
        if (replacement) {
            result = result.replace(hash, replacement);
            replacedHashes.push(hash);
        }
    }
    return result;
}
let lastMissedBracket = false;
function replaceBlocks(input, replacedHashes = new Array()) {
    var _a, _b, _c, _d;
    let result = input;
    const fullOpeningTags = (_a = input.match(/<BPGT.*?EPGT>/g)) !== null && _a !== void 0 ? _a : [];
    const openOpeningTag = ((_b = input.match(/<BPGT.*?EPGT(?!>)/g)) !== null && _b !== void 0 ? _b : [])[0];
    const fullClosingTags = (_c = input.match(/<\/BPGT.*?EPGT>/g)) !== null && _c !== void 0 ? _c : [];
    const openClosingTag = ((_d = input.match(/<\/BPGT.*?EPGT(?!>)/g)) !== null && _d !== void 0 ? _d : [])[0];
    if (lastMissedBracket && input.match(/[\t ]*>/)) {
        lastMissedBracket = false;
        result = result.replace(/[\t ]*>/, "");
    }
    fullOpeningTags.forEach((openingTag) => {
        replacedHashes.push(openingTag);
        result = result.replace(openingTag, replacements.get(openingTag));
    });
    if (openOpeningTag) {
        const fixedOpeningTag = openOpeningTag + ">";
        lastMissedBracket = true;
        replacedHashes.push(fixedOpeningTag);
        result = result.replace(openOpeningTag, replacements.get(fixedOpeningTag));
    }
    fullClosingTags.forEach((fullClosingTag) => {
        replacedHashes.push(fullClosingTag);
        result = result.replace(fullClosingTag, replacements.get(fullClosingTag));
    });
    if (openClosingTag) {
        const fixedClosingTag = openClosingTag + ">";
        lastMissedBracket = true;
        replacedHashes.push(fixedClosingTag);
        result = result.replace(openClosingTag, replacements.get(fixedClosingTag));
    }
    return result;
}
exports.printers = {
    "go-template": {
        embed: (_, __, textToDoc, options) => {
            const htmlDoc = textToDoc(options.originalText, {
                parser: "html",
            });
            const replacedHashes = [];
            const mappedDoc = prettier_1.doc.utils.mapDoc(htmlDoc, (docLeaf) => {
                if (typeof docLeaf !== "string") {
                    return docLeaf;
                }
                let result = docLeaf;
                result = replaceSingles(result, replacedHashes);
                result = replaceBlocks(result, replacedHashes);
                return result;
            });
            replacedHashes.forEach((hash) => replacements.delete(hash));
            return mappedDoc;
        },
    },
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsdUNBQWlFO0FBQ2pFLHNEQUE4RDtBQUU5RCxNQUFNLFdBQVcsR0FBRyxJQUFJLEtBQUssRUFBVSxDQUFDO0FBQ3hDLE1BQU0sVUFBVSxHQUFHLHFCQUFXLENBQUMsSUFBSSxDQUFDO0FBRXBDLElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztBQUNaLE1BQU0sS0FBSyxHQUFHLEdBQUcsRUFBRTtJQUNqQixHQUFHLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0lBQzFDLE9BQU8sR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQ3hCLENBQUMsQ0FBQztBQUVGLE1BQU0sZ0JBQWdCLEdBQUcsQ0FBQyxLQUFhLEVBQUUsYUFBc0IsRUFBRSxFQUFFO0lBQ2pFLE1BQU0sRUFBRSxHQUFHLEtBQUssRUFBRSxDQUFDO0lBRW5CLElBQUksYUFBYSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsd0NBQXdDLENBQUMsRUFBRTtRQUMxRSxXQUFXLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ3JCLE9BQU8sUUFBUSxFQUFFLE9BQU8sQ0FBQztLQUMxQjtJQUVELElBQUksYUFBYSxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsYUFBYSxDQUFDLEVBQUU7UUFDL0MsT0FBTyxTQUFTLFdBQVcsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDO0tBQzFDO0lBRUQsT0FBTyxPQUFPLEVBQUUsTUFBTSxDQUFDO0FBQ3pCLENBQUMsQ0FBQztBQUVGLE1BQU0sWUFBWSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO0FBRWxDLFFBQUEsT0FBTyxHQUFHO0lBQ3JCLGFBQWEsRUFBRSxnQ0FDVixVQUFVLEtBQ2IsU0FBUyxFQUFFLGFBQWEsRUFDeEIsVUFBVSxFQUFFLENBQUMs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QUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUNyQyxNQUFNLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsWUFBWSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUUsQ0FBQyxDQUFDO0tBQzdFO0lBRUQsT0FBTyxNQUFNLENBQUM7QUFDaEIsQ0FBQztBQUVZLFFBQUEsUUFBUSxHQUFHO0lBQ3RCLGFBQWEsRUFBVztRQUN0QixLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUNuQyxNQUFNLE9BQU8sR0FBRyxTQUFTLENBQUMsT0FBTyxDQUFDLFlBQVksRUFBRTtnQkFDOUMsTUFBTSxFQUFFLE1BQU07YUFDZixDQUFDLENBQUM7WUFFSCxNQUFNLGNBQWMsR0FBYSxFQUFFLENBQUM7WUFFcEMsTUFBTSxTQUFTLEdBQUcsY0FBRyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxFQUFFLEVBQUU7Z0JBQ3RELElBQUksT0FBTyxPQUFPLEtBQUssUUFBUSxFQUFFO29CQUMvQixPQUFPLE9BQU8sQ0FBQztpQkFDaEI7Z0JBRUQsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDO2dCQUVyQixNQUFNLEdBQUcsY0FBYyxDQUFDLE1BQU0sRUFBRSxjQUFjLENBQUMsQ0FBQztnQkFFaEQsTUFBTSxHQUFHLGFBQWEsQ0FBQyxNQUFNLEVBQUUsY0FBYyxDQUFDLENBQUM7Z0JBRS9DLE9BQU8sTUFBTSxDQUFDO1lBQ2hCLENBQUMsQ0FBQyxDQUFDO1lBRUgsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1lBRTVELE9BQU8sU0FBUyxDQUFDO1FBQ25CLENBQUM7S0FDRjtDQUNGLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBkb2MsIFBhcnNlciwgUHJpbnRlciwgU3VwcG9ydExhbmd1YWdlIH0gZnJvbSBcInByZXR0aWVyXCI7XG5pbXBvcnQgeyBwYXJzZXJzIGFzIGh0bWxQYXJzZXJzIH0gZnJvbSBcInByZXR0aWVyL3BhcnNlci1odG1sXCI7XG5cbmNvbnN0IGJsb2NrSGFzaGVzID0gbmV3IEFycmF5PHN0cmluZz4oKTtcbmNvbnN0IGh0bWxQYXJzZXIgPSBodG1sUGFyc2Vycy5odG1sO1xuXG5sZXQgX2lkID0gMDtcbmNvbnN0IGdldElkID0gKCkgPT4ge1xuICBfaWQgPSBfaWQgKyAoMSAlIE51bWJlci5NQVhfU0FGRV9JTlRFR0VSKTtcbiAgcmV0dXJuIF9pZC50b1N0cmluZygpO1xufTtcblxuY29uc3QgYnVpbGRSZXBsYWNlbWVudCA9IChpbnB1dDogc3RyaW5nLCBhbGxUYWdzQ2xvc2VkOiBib29sZWFuKSA9PiB7XG4gIGNvbnN0IGlkID0gZ2V0SWQoKTtcblxuICBpZiAoYWxsVGFnc0Nsb3NlZCAmJiBpbnB1dC5tYXRjaCgve3tbLTxdPyAoPzppZnxyYW5nZXxibG9ja3x3aXRofGRlZmluZSkvKSkge1xuICAgIGJsb2NrSGFzaGVzLnB1c2goaWQpO1xuICAgIHJldHVybiBgPEJQR1Qke2lkfUVQR1Q+YDtcbiAgfVxuXG4gIGlmIChhbGxUYWdzQ2xvc2VkICYmIGlucHV0Lm1hdGNoKC97e1stPF0/IGVuZC8pKSB7XG4gICAgcmV0dXJuIGA8L0JQR1Qke2Jsb2NrSGFzaGVzLnBvcCgpfUVQR1Q+YDtcbiAgfVxuXG4gIHJldHVybiBgQlBHVCR7aWR9RVBHVGA7XG59O1xuXG5jb25zdCByZXBsYWNlbWVudHMgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuXG5leHBvcnQgY29uc3QgcGFyc2VycyA9IHtcbiAgXCJnby10ZW1wbGF0ZVwiOiA8UGFyc2VyPntcbiAgICAuLi5odG1sUGFyc2VyLFxuICAgIGFzdEZvcm1hdDogXCJnby10ZW1wbGF0ZVwiLFxuICAgIHByZXByb2Nlc3M6ICh0ZXh0KSA9PiB7XG4gICAgICAvL1xuICAgICAgY29uc3QgcmVnZXhwID0gLyg/Ont7Lio/fX0pfCg/OjxzY3JpcHQoPzpcXG58LikqPz4pKCg/OlxcbnwuKSo/KSg/OjxcXC9zY3JpcHQ+KS9nbTtcblxuICAgICAgbGV0IHJlcGxhY2VkVGV4dCA9IHRleHQudHJpbSgpO1xuICAgICAgbGV0IG1hdGNoOiBSZWdFeHBFeGVjQXJyYXkgfCBudWxsO1xuICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOiBuby1jb25kaXRpb25hbC1hc3NpZ25tZW50XG4gICAgICB3aGlsZSAoKG1hdGNoID0gcmVnZXhwLmV4ZWModGV4dCkpICE9IG51bGwpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gbWF0Y2hbMF07XG5cbiAgICAgICAgaWYgKCFyZXN1bHQuaW5jbHVkZXMoXCJ7e1wiKSkge1xuICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgY2xlYW5lZFJlc3VsdCA9IHJlc3VsdFxuICAgICAgICAgIC8vIGNsZWFuIGV4Y2VwdCBmb3IgaHlwaGVucywgc2hvcnRjb2RlcywgY29tbWVudHNcbiAgICAgICAgICAucmVwbGFjZSgve3soPyFbLTxdfCg/OlxcL1xcKikpWyBcXHRdKi9nLCBcInt7IFwiKVxuICAgICAgICAgIC5yZXBsYWNlKC9bIFxcdF0qKD88IVstPl18KD86XFwqXFwvKSl9fS9nLCBcIiB9fVwiKVxuXG4gICAgICAgICAgLy8gY2xlYW4gaHlwaGVuc1xuICAgICAgICAgIC5yZXBsYWNlKC97ey1bIFxcdF0qL2csIFwie3stIFwiKVxuICAgICAgICAgIC5yZXBsYWNlKC9bIFxcdF0qLX19L2csIFwiIC19fVwiKVxuXG4gICAgICAgICAgLy8gY2xlYW4gc2hvcnRjb2RlcywgZS5nLiBcInt7PCAgICB5ZWFyICAgID59fVwiIC0+IFwie3s8IHllYXIgPn19XCJcbiAgICAgICAgICAucmVwbGFjZSgve3s8WyBcXHRdKi9nLCBcInt7PCBcIilcbiAgICAgICAgICAucmVwbGFjZSgvWyBcXHRdKj59fS9nLCBcIiA+fX1cIilcblxuICAgICAgICAgIC5yZXBsYWNlKC8gKlxcbi9nLCBcIlxcblwiKVxuICAgICAgICAgIC50cmltKCk7XG5cbiAgICAgICAgY29uc3QgcmVzdWx0SW5kZXggPSByZXBsYWNlZFRleHQuaW5kZXhPZihyZXN1bHQpO1xuICAgICAgICBjb25zdCBwcmVmaXhTdHJpbmcgPSByZXBsYWNlZFRleHQuc3Vic3RyaW5nKDAsIHJlc3VsdEluZGV4KTtcblxuICAgICAgICBjb25zdCBvcGVuaW5nVGFncyA9IHByZWZpeFN0cmluZy5tYXRjaCgvPFtcXHcvXS8pPy5sZW5ndGg7XG4gICAgICAgIGNvbnN0IGNsb3NpbmdUYWdzID0gcHJlZml4U3RyaW5nLm1hdGNoKC9bXFx3L10+Lyk/Lmxlbmd0aDtcblxuICAgICAgICBjb25zdCByZXBsYWNlbWVudCA9IGJ1aWxkUmVwbGFjZW1lbnQoXG4gICAgICAgICAgY2xlYW5lZFJlc3VsdCxcbiAgICAgICAgICBvcGVuaW5nVGFncyA9PT0gY2xvc2luZ1RhZ3NcbiAgICAgICAgKTtcblxuICAgICAgICByZXBsYWNlZFRleHQgPSByZXBsYWNlZFRleHQucmVwbGFjZShyZXN1bHQsIHJlcGxhY2VtZW50KTtcblxuICAgICAgICBjb25zdCBmb3JjZUxpbmVicmVhayA9ICEhcmVwbGFjZWRUZXh0Lm1hdGNoKFxuICAgICAgICAgIG5ldyBSZWdFeHAoYF5bIFxcdF0qJHtyZXBsYWNlbWVudH1bIFxcdF0qJGAsIFwiZ21cIilcbiAgICAgICAgKTtcblxuICAgICAgICBpZiAoZm9yY2VMaW5lYnJlYWsgJiYgIXJlcGxhY2VtZW50LmluY2x1ZGVzKFwiPFwiKSkge1xuICAgICAgICAgIGNvbnN0IGxpbmVicmVha1JlcGxhY2VtZW50ID0gYDwhLS1CUEdUJHtyZXBsYWNlbWVudH1FUEdULS0+YDtcblxuICAgICAgICAgIHJlcGxhY2VkVGV4dCA9IHJlcGxhY2VkVGV4dC5yZXBsYWNlKFxuICAgICAgICAgICAgcmVwbGFjZW1lbnQsXG4gICAgICAgICAgICBsaW5lYnJlYWtSZXBsYWNlbWVudFxuICAgICAgICAgICk7XG4gICAgICAgICAgcmVwbGFjZW1lbnRzLnNldChsaW5lYnJlYWtSZXBsYWNlbWVudCwgY2xlYW5lZFJlc3VsdCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcmVwbGFjZW1lbnRzLnNldChyZXBsYWNlbWVudCwgY2xlYW5lZFJlc3VsdCk7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKGJsb2NrSGFzaGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJNaXNzaW5nIGVuZGluZyBibG9jay5cIik7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXBsYWNlZFRleHQ7XG4gICAgfSxcbiAgfSxcbn07XG5cbmV4cG9ydCBjb25zdCBsYW5ndWFnZXM6IFN1cHBvcnRMYW5ndWFnZVtdID0gW1xuICB7XG4gICAgbmFtZTogXCJHb1RlbXBsYXRlXCIsXG4gICAgcGFyc2VyczogW1wiZ28tdGVtcGxhdGVcIl0sXG4gICAgZXh0ZW5zaW9uczogW1xuICAgICAgXCIuZ28uaHRtbFwiLFxuICAgICAgXCIuZ29odG1sXCIsXG4gICAgICBcIi5nb3RtcGxcIixcbiAgICAgIFwiLmdvLnRtcGxcIixcbiAgICAgIFwiLnRtcGxcIixcbiAgICAgIFwiLnRwbFwiLFxuICAgICAgXCIuaHRtbC50bXBsXCIsXG4gICAgICBcIi5odG1sLnRwbFwiLFxuICAgIF0sXG4gICAgdnNjb2RlTGFuZ3VhZ2VJZHM6IFtcImdvdGVtcGxhdGVcIiwgXCJnb2h0bWxcIiwgXCJHb1RlbXBsYXRlXCIsIFwiR29IVE1MXCJdLFxuICB9LFxuXTtcblxuZnVuY3Rpb24gcmVwbGFjZVNpbmdsZXMoaW5wdXQ6IHN0cmluZywgcmVwbGFjZWRIYXNoZXMgPSBuZXcgQXJyYXk8c3RyaW5nPigpKSB7XG4gIGNvbnN0IHJlZ2V4cCA9IC8oPzo8IS0tQlBHVCk/QlBHVC4qP0VQR1QoPzpFUEdULS0+KT8vZztcblxuICBsZXQgcmVzdWx0ID0gaW5wdXQ7XG4gIGxldCBtYXRjaDogUmVnRXhwRXhlY0FycmF5IHwgbnVsbDtcblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6IG5vLWNvbmRpdGlvbmFsLWFzc2lnbm1lbnRcbiAgd2hpbGUgKChtYXRjaCA9IHJlZ2V4cC5leGVjKGlucHV0KSkgIT0gbnVsbCkge1xuICAgIGNvbnN0IGhhc2ggPSBtYXRjaFswXTtcblxuICAgIGNvbnN0IHJlcGxhY2VtZW50ID0gcmVwbGFjZW1lbnRzLmdldChoYXNoKTtcblxuICAgIGlmIChyZXBsYWNlbWVudCkge1xuICAgICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoaGFzaCwgcmVwbGFjZW1lbnQpO1xuICAgICAgcmVwbGFjZWRIYXNoZXMucHVzaChoYXNoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5sZXQgbGFzdE1pc3NlZEJyYWNrZXQgPSBmYWxzZTtcblxuZnVuY3Rpb24gcmVwbGFjZUJsb2NrcyhpbnB1dDogc3RyaW5nLCByZXBsYWNlZEhhc2hlcyA9IG5ldyBBcnJheTxzdHJpbmc+KCkpIHtcbiAgbGV0IHJlc3VsdCA9IGlucHV0O1xuXG4gIGNvbnN0IGZ1bGxPcGVuaW5nVGFncyA9IGlucHV0Lm1hdGNoKC88QlBHVC4qP0VQR1Q+L2cpID8/IFtdO1xuICBjb25zdCBvcGVuT3BlbmluZ1RhZyA9IChpbnB1dC5tYXRjaCgvPEJQR1QuKj9FUEdUKD8hPikvZykgPz8gW10pWzBdO1xuICBjb25zdCBmdWxsQ2xvc2luZ1RhZ3MgPSBpbnB1dC5tYXRjaCgvPFxcL0JQR1QuKj9FUEdUPi9nKSA/PyBbXTtcbiAgY29uc3Qgb3BlbkNsb3NpbmdUYWcgPSAoaW5wdXQubWF0Y2goLzxcXC9CUEdULio/RVBHVCg/IT4pL2cpID8/IFtdKVswXTtcblxuICBpZiAobGFzdE1pc3NlZEJyYWNrZXQgJiYgaW5wdXQubWF0Y2goL1tcXHQgXSo+LykpIHtcbiAgICBsYXN0TWlzc2VkQnJhY2tldCA9IGZhbHNlO1xuICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKC9bXFx0IF0qPi8sIFwiXCIpO1xuICB9XG5cbiAgZnVsbE9wZW5pbmdUYWdzLmZvckVhY2goKG9wZW5pbmdUYWcpID0+IHtcbiAgICByZXBsYWNlZEhhc2hlcy5wdXNoKG9wZW5pbmdUYWcpO1xuICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKG9wZW5pbmdUYWcsIHJlcGxhY2VtZW50cy5nZXQob3BlbmluZ1RhZykhKTtcbiAgfSk7XG5cbiAgaWYgKG9wZW5PcGVuaW5nVGFnKSB7XG4gICAgY29uc3QgZml4ZWRPcGVuaW5nVGFnID0gb3Blbk9wZW5pbmdUYWcgKyBcIj5cIjtcbiAgICBsYXN0TWlzc2VkQnJhY2tldCA9IHRydWU7XG5cbiAgICByZXBsYWNlZEhhc2hlcy5wdXNoKGZpeGVkT3BlbmluZ1RhZyk7XG4gICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2Uob3Blbk9wZW5pbmdUYWcsIHJlcGxhY2VtZW50cy5nZXQoZml4ZWRPcGVuaW5nVGFnKSEpO1xuICB9XG5cbiAgZnVsbENsb3NpbmdUYWdzLmZvckVhY2goKGZ1bGxDbG9zaW5nVGFnKSA9PiB7XG4gICAgcmVwbGFjZWRIYXNoZXMucHVzaChmdWxsQ2xvc2luZ1RhZyk7XG4gICAgcmVzdWx0ID0gcmVzdWx0LnJlcGxhY2UoZnVsbENsb3NpbmdUYWcsIHJlcGxhY2VtZW50cy5nZXQoZnVsbENsb3NpbmdUYWcpISk7XG4gIH0pO1xuXG4gIGlmIChvcGVuQ2xvc2luZ1RhZykge1xuICAgIGNvbnN0IGZpeGVkQ2xvc2luZ1RhZyA9IG9wZW5DbG9zaW5nVGFnICsgXCI+XCI7XG4gICAgbGFzdE1pc3NlZEJyYWNrZXQgPSB0cnVlO1xuXG4gICAgcmVwbGFjZWRIYXNoZXMucHVzaChmaXhlZENsb3NpbmdUYWcpO1xuICAgIHJlc3VsdCA9IHJlc3VsdC5yZXBsYWNlKG9wZW5DbG9zaW5nVGFnLCByZXBsYWNlbWVudHMuZ2V0KGZpeGVkQ2xvc2luZ1RhZykhKTtcbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBjb25zdCBwcmludGVycyA9IHtcbiAgXCJnby10ZW1wbGF0ZVwiOiA8UHJpbnRlcj57XG4gICAgZW1iZWQ6IChfLCBfXywgdGV4dFRvRG9jLCBvcHRpb25zKSA9PiB7XG4gICAgICBjb25zdCBodG1sRG9jID0gdGV4dFRvRG9jKG9wdGlvbnMub3JpZ2luYWxUZXh0LCB7XG4gICAgICAgIHBhcnNlcjogXCJodG1sXCIsXG4gICAgICB9KTtcblxuICAgICAgY29uc3QgcmVwbGFjZWRIYXNoZXM6IHN0cmluZ1tdID0gW107XG5cbiAgICAgIGNvbnN0IG1hcHBlZERvYyA9IGRvYy51dGlscy5tYXBEb2MoaHRtbERvYywgKGRvY0xlYWYpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBkb2NMZWFmICE9PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgcmV0dXJuIGRvY0xlYWY7XG4gICAgICAgIH1cblxuICAgICAgICBsZXQgcmVzdWx0ID0gZG9jTGVhZjtcblxuICAgICAgICByZXN1bHQgPSByZXBsYWNlU2luZ2xlcyhyZXN1bHQsIHJlcGxhY2VkSGFzaGVzKTtcblxuICAgICAgICByZXN1bHQgPSByZXBsYWNlQmxvY2tzKHJlc3VsdCwgcmVwbGFjZWRIYXNoZXMpO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KTtcblxuICAgICAgcmVwbGFjZWRIYXNoZXMuZm9yRWFjaCgoaGFzaCkgPT4gcmVwbGFjZW1lbnRzLmRlbGV0ZShoYXNoKSk7XG5cbiAgICAgIHJldHVybiBtYXBwZWREb2M7XG4gICAgfSxcbiAgfSxcbn07XG4iXX0=